<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Search SOC Inventory</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 1200px; margin: 40px auto; padding: 0 20px; }
      .search-form { margin-bottom: 20px; }
      input[type="search"] { 
        width: 300px; 
        padding: 8px;
        margin-right: 8px;
      }
      button { padding: 8px 16px; }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th { 
        background: #f5f5f5;
        position: sticky;
        top: 0;
      }
      tr:hover { background: #f9f9f9; }
      .no-results {
        padding: 20px;
        text-align: center;
        color: #666;
      }
      .nav-links {
        margin-bottom: 20px;
      }
      .nav-links a {
        margin-right: 15px;
        color: #0066cc;
        text-decoration: none;
      }
      .nav-links a:hover {
        text-decoration: underline;
      }
      .edit-form {
        padding: 20px;
        background: #f5f5f5;
        border-radius: 4px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }
      .form-group {
        flex: 1;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: #666;
      }
      .form-group input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .button-row {
        margin-top: 20px;
        text-align: right;
      }
      .edit-btn, .save-btn, .cancel-btn, .delete-btn, .detail-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .detail-btn {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #17a2b8;
        margin-right: 5px;
      }
      .detail-btn:hover {
        background: #17a2b8;
        color: white;
      }
      .edit-btn {
        background: #e7f3ff;
        color: #0066cc;
        margin-right: 5px;
      }
      .delete-btn {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffc107;
      }
      .delete-btn:hover {
        background: #ffc107;
        color: #000;
      }
      .save-btn {
        background: #28a745;
        color: white;
        margin-right: 10px;
      }
      .cancel-btn {
        background: #dc3545;
        color: white;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
        background-color: #fefefe;
        margin: 5% auto;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 80%;
        max-width: 800px;
        max-height: 80vh;
        overflow-y: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #ddd;
        padding-bottom: 10px;
        margin-bottom: 20px;
      }
      .modal-header h2 {
        margin: 0;
        color: #333;
      }
      .close {
        color: #aaa;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close:hover,
      .close:focus {
        color: #000;
      }
      .detail-grid {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 15px;
        row-gap: 10px;
      }
      .detail-label {
        font-weight: bold;
        color: #555;
      }
      .detail-value {
        color: #333;
      }
      .detail-section {
        grid-column: 1 / -1;
        font-weight: bold;
        color: #0066cc;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #ddd;
      }
      .detail-section:first-child {
        margin-top: 0;
        padding-top: 0;
        border-top: none;
      }
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin: 20px 0;
        padding: 20px 0;
      }
      .pagination-info {
        margin-right: 20px;
        color: #666;
      }
      .pagination button {
        padding: 8px 16px;
        border: 1px solid #ddd;
        background: white;
        cursor: pointer;
        border-radius: 4px;
      }
      .pagination button:hover:not(:disabled) {
        background: #f0f0f0;
      }
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pagination .page-number {
        padding: 8px 12px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="nav-links">
      <a href="/add">Add New Item</a>
      <a href="/search">Quick Search</a>
      <a href="/advanced-search">Advanced Search</a>
      <a href="/bulk-import">Bulk Import</a>
    </div>

    <h1>Search SOC Inventory</h1>

      <form class="search-form" id="searchForm">
        <input 
          type="search" 
          id="searchInput" 
          name="q" 
          placeholder="Search by label, type, brand, etc... (use * for all)"
          value="{{ request.args.get('q', '') }}"
        >
        <button type="submit">Search</button>
        {% if items %}
          <button type="button" onclick="downloadCSV()" class="download-btn">
            Download Results as CSV
          </button>
        {% endif %}
      </form>    <div id="results">
      {% if items %}
        <table>
          <thead>
            <tr>
              <th>Label</th>
              <th>Type</th>
              <th>Brand</th>
              <th>Model</th>
              <th>Serial No</th>
              <th>Spec 1</th>
              <th>Spec 2</th>
              <th>Spec 3</th>
              <th>Project</th>
              <th>Department</th>
              <th>Status</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr data-id="{{ loop.index }}"
                  data-record-date="{{ item.record_date }}"
                  data-label="{{ item.label }}"
                  data-type="{{ item.type }}"
                  data-brand="{{ item.brand }}"
                  data-model-no="{{ item.model_no }}"
                  data-serial-no="{{ item.serial_no }}"
                  data-location="{{ item.location }}"
                  data-location-2="{{ item.location_2 }}"
                  data-location-3="{{ item.location_3 }}"
                  data-invoice-no="{{ item.invoice_no }}"
                  data-purchase-date="{{ item.purchase_date }}"
                  data-price="{{ item.price }}"
                  data-maintenance-end-date="{{ item.maintenance_end_date }}"
                  data-specification1="{{ item.specification1 }}"
                  data-specification2="{{ item.specification2 }}"
                  data-specification3="{{ item.specification3 }}"
                  data-project-code="{{ item.project_code }}"
                  data-department="{{ item.department }}"
                  data-status="{{ item.status }}"
                  data-created-at="{{ item.created_at }}"
                  data-updated-at="{{ item.updated_at }}">
                <td>{{ item.label }}</td>
                <td>{{ item.type }}</td>
                <td>{{ item.brand }}</td>
                <td>{{ item.model_no }}</td>
                <td>{{ item.serial_no }}</td>
                <td>{{ item.specification1 }}</td>
                <td>{{ item.specification2 }}</td>
                <td>{{ item.specification3 }}</td>
                <td>{{ item.project_code }}</td>
                <td>{{ item.department }}</td>
                <td>{{ item.status }}</td>
                <td title="Created: {{ item.created_at }}">{{ item.updated_at }}</td>
                <td>
                  <button onclick="showDetail({{ loop.index }})" class="detail-btn">Detail</button>
                  <button onclick="editItem({{ loop.index }})" class="edit-btn">Edit</button>
                  <button onclick="deleteItem('{{ item.serial_no }}', {{ loop.index }})" class="delete-btn">Delete</button>
                </td>
              </tr>
              <tr id="edit-form-{{ loop.index }}" style="display: none;">
                <td colspan="14">
                  <form class="edit-form" onsubmit="updateItem(event, {{ loop.index }})">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Record Date</label>
                        <input type="date" name="record_date" value="{{ item.record_date }}">
                      </div>
                      <div class="form-group">
                        <label>Label</label>
                        <input type="text" name="label" value="{{ item.label }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Type</label>
                        <input type="text" name="type" value="{{ item.type }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Brand</label>
                        <input type="text" name="brand" value="{{ item.brand }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Model No</label>
                        <input type="text" name="model_no" value="{{ item.model_no }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Serial No</label>
                        <input type="text" name="serial_no" value="{{ item.serial_no }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="location" value="{{ item.location }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Location 2</label>
                        <input type="text" name="location_2" value="{{ item.location_2 }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Location 3</label>
                        <input type="text" name="location_3" value="{{ item.location_3 }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Specification 1</label>
                        <input type="text" name="specification1" value="{{ item.specification1 }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Specification 2</label>
                        <input type="text" name="specification2" value="{{ item.specification2 }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Specification 3</label>
                        <input type="text" name="specification3" value="{{ item.specification3 }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Project Code</label>
                        <input type="text" name="project_code" value="{{ item.project_code }}" maxlength="50">
                      </div>
                      <div class="form-group">
                        <label>Department</label>
                        <input type="text" name="department" value="{{ item.department }}" maxlength="50">
                      </div>
                      <div class="form-group">
                        <label>Status</label>
                        <input type="text" name="status" value="{{ item.status }}" maxlength="50">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Invoice No</label>
                        <input type="text" name="invoice_no" value="{{ item.invoice_no }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" name="purchase_date" value="{{ item.purchase_date }}">
                      </div>
                      <div class="form-group">
                        <label>Price</label>
                        <input type="number" name="price" value="{{ item.price }}" step="0.01">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Maintenance End Date</label>
                        <input type="date" name="maintenance_end_date" value="{{ item.maintenance_end_date }}">
                      </div>
                    </div>
                    <div class="button-row">
                      <button type="submit" class="save-btn">Save Changes</button>
                      <button type="button" onclick="cancelEdit({{ loop.index }})" class="cancel-btn">Cancel</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        
        <!-- Pagination Controls -->
        {% if total_pages > 1 %}
        <div class="pagination">
          <span class="pagination-info">
            Showing {{ ((page - 1) * per_page) + 1 }} - {{ [page * per_page, total_count] | min }} of {{ total_count }} items
          </span>
          <button onclick="goToPage(1)" {% if page == 1 %}disabled{% endif %}>First</button>
          <button onclick="goToPage({{ page - 1 }})" {% if page == 1 %}disabled{% endif %}>Previous</button>
          <span class="page-number">Page {{ page }} of {{ total_pages }}</span>
          <button onclick="goToPage({{ page + 1 }})" {% if page == total_pages %}disabled{% endif %}>Next</button>
          <button onclick="goToPage({{ total_pages }})" {% if page == total_pages %}disabled{% endif %}>Last</button>
        </div>
        {% endif %}
        
      {% elif search_performed %}
        <div class="no-results">No items found matching your search.</div>
      {% endif %}
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Item Details</h2>
          <span class="close" onclick="closeDetailModal()">&times;</span>
        </div>
        <div id="detailContent" class="detail-grid">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <script>
      // Detail Modal Functions
      function showDetail(rowId) {
        const row = document.querySelector(`tr[data-id="${rowId}"]`);
        if (!row) return;
        
        const data = {
          'Record Date': row.dataset.recordDate || 'N/A',
          'Label': row.dataset.label || 'N/A',
          'Type': row.dataset.type || 'N/A',
          'Brand': row.dataset.brand || 'N/A',
          'Model No': row.dataset.modelNo || 'N/A',
          'Serial No': row.dataset.serialNo || 'N/A',
          'Location': row.dataset.location || 'N/A',
          'Location 2': row.dataset.location2 || 'N/A',
          'Location 3': row.dataset.location3 || 'N/A',
          'Invoice No': row.dataset.invoiceNo || 'N/A',
          'Purchase Date': row.dataset.purchaseDate || 'N/A',
          'Price': row.dataset.price || 'N/A',
          'Maintenance End Date': row.dataset.maintenanceEndDate || 'N/A',
          'Specification 1': row.dataset.specification1 || 'N/A',
          'Specification 2': row.dataset.specification2 || 'N/A',
          'Specification 3': row.dataset.specification3 || 'N/A',
          'Project Code': row.dataset.projectCode || 'N/A',
          'Department': row.dataset.department || 'N/A',
          'Status': row.dataset.status || 'N/A',
          'Created At': row.dataset.createdAt || 'N/A',
          'Updated At': row.dataset.updatedAt || 'N/A'
        };
        
        const detailContent = document.getElementById('detailContent');
        detailContent.innerHTML = '';
        
        // Basic Information Section
        detailContent.innerHTML += '<div class="detail-section">Basic Information</div>';
        ['Record Date', 'Label', 'Type', 'Brand', 'Model No', 'Serial No'].forEach(key => {
          detailContent.innerHTML += `
            <div class="detail-label">${key}:</div>
            <div class="detail-value">${data[key]}</div>
          `;
        });
        
        // Location Information Section
        detailContent.innerHTML += '<div class="detail-section">Location Information</div>';
        ['Location', 'Location 2', 'Location 3'].forEach(key => {
          detailContent.innerHTML += `
            <div class="detail-label">${key}:</div>
            <div class="detail-value">${data[key]}</div>
          `;
        });
        
        // Specifications Section
        detailContent.innerHTML += '<div class="detail-section">Specifications</div>';
        ['Specification 1', 'Specification 2', 'Specification 3'].forEach(key => {
          detailContent.innerHTML += `
            <div class="detail-label">${key}:</div>
            <div class="detail-value">${data[key]}</div>
          `;
        });
        
        // Project & Department Section
        detailContent.innerHTML += '<div class="detail-section">Project & Department</div>';
        ['Project Code', 'Department', 'Status'].forEach(key => {
          detailContent.innerHTML += `
            <div class="detail-label">${key}:</div>
            <div class="detail-value">${data[key]}</div>
          `;
        });
        
        // Financial Information Section
        detailContent.innerHTML += '<div class="detail-section">Financial Information</div>';
        ['Invoice No', 'Purchase Date', 'Price', 'Maintenance End Date'].forEach(key => {
          detailContent.innerHTML += `
            <div class="detail-label">${key}:</div>
            <div class="detail-value">${data[key]}</div>
          `;
        });
        
        // Timestamps Section
        detailContent.innerHTML += '<div class="detail-section">Timestamps</div>';
        ['Created At', 'Updated At'].forEach(key => {
          detailContent.innerHTML += `
            <div class="detail-label">${key}:</div>
            <div class="detail-value">${data[key]}</div>
          `;
        });
        
        document.getElementById('detailModal').style.display = 'block';
      }
      
      function closeDetailModal() {
        document.getElementById('detailModal').style.display = 'none';
      }
      
      // Close modal when clicking outside of it
      window.onclick = function(event) {
        const modal = document.getElementById('detailModal');
        if (event.target == modal) {
          closeDetailModal();
        }
      }
      
      // Pagination function
      function goToPage(pageNum) {
        const searchQuery = document.getElementById('searchInput').value;
        const url = new URL(window.location.href);
        url.searchParams.set('q', searchQuery);
        url.searchParams.set('page', pageNum);
        window.location.href = url.toString();
      }
      
      // Function to download search results as CSV
      async function downloadCSV() {
        const searchQuery = document.getElementById('searchInput').value;
        try {
          const response = await fetch(`/api/items/export-csv?q=${encodeURIComponent(searchQuery)}`, {
            method: 'GET',
          });
          
          if (!response.ok) {
            throw new Error('Failed to download CSV');
          }

          // Get filename from Content-Disposition header or use default
          let filename = 'inventory-export.csv';
          const disposition = response.headers.get('Content-Disposition');
          if (disposition && disposition.indexOf('attachment') !== -1) {
            const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
            const matches = filenameRegex.exec(disposition);
            if (matches != null && matches[1]) {
              filename = matches[1].replace(/['"]/g, '');
            }
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        } catch (err) {
          alert('Error downloading CSV: ' + err.message);
        }
      }

      // Enable instant search as user types (with debouncing)
      const searchInput = document.getElementById('searchInput');
      const searchForm = document.getElementById('searchForm');
      let timeoutId;

      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          // Reset to page 1 on new search
          const url = new URL(window.location.href);
          url.searchParams.delete('page');
          window.location.href = url.toString().split('?')[0] + '?q=' + encodeURIComponent(searchInput.value);
        }, 300); // Wait 300ms after user stops typing
      });

      // Edit functionality
      function editItem(id) {
        // Hide all other edit forms first
        document.querySelectorAll('.edit-form').forEach(form => {
          form.parentElement.parentElement.style.display = 'none';
        });
        // Show this edit form
        document.getElementById(`edit-form-${id}`).style.display = 'table-row';
      }

      function cancelEdit(id) {
        document.getElementById(`edit-form-${id}`).style.display = 'none';
      }

      async function updateItem(event, id) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        // Convert FormData to object with proper null handling
        const payload = {};
        for (let [key, value] of formData.entries()) {
          payload[key] = value.trim() || null;
        }

        try {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            // Refresh the page to show updated data
            window.location.reload();
          } else {
            const data = await res.json();
            alert(data.error || 'Failed to update item');
          }
        } catch (err) {
          alert('Network error: ' + err.message);
        }
      }

      // Delete functionality
      async function deleteItem(serialNo, rowId) {
        if (!confirm(`Are you sure you want to delete item with Serial No: ${serialNo}?\n\nThis action cannot be undone.`)) {
          return;
        }

        try {
          const res = await fetch(`/api/items/${encodeURIComponent(serialNo)}`, {
            method: 'DELETE'
          });

          if (res.ok) {
            // Refresh the page to show updated data
            window.location.reload();
          } else {
            const data = await res.json();
            alert(data.error || 'Failed to delete item');
          }
        } catch (err) {
          alert('Network error: ' + err.message);
        }
      }

      // CSV Import functionality

    </script>
  </body>
</html>