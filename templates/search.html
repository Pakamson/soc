<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Search SOC Inventory</title>
    <style>
      body { font-family: Arial, sans-serif; max-width: 1200px; margin: 40px auto; padding: 0 20px; }
      .search-form { margin-bottom: 20px; }
      input[type="search"] { 
        width: 300px; 
        padding: 8px;
        margin-right: 8px;
      }
      button { padding: 8px 16px; }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      th { 
        background: #f5f5f5;
        position: sticky;
        top: 0;
      }
      tr:hover { background: #f9f9f9; }
      .no-results {
        padding: 20px;
        text-align: center;
        color: #666;
      }
      .nav-links {
        margin-bottom: 20px;
      }
      .nav-links a {
        margin-right: 15px;
        color: #0066cc;
        text-decoration: none;
      }
      .nav-links a:hover {
        text-decoration: underline;
      }
      .edit-form {
        padding: 20px;
        background: #f5f5f5;
        border-radius: 4px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }
      .form-group {
        flex: 1;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9em;
        color: #666;
      }
      .form-group input {
        width: 100%;
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      .button-row {
        margin-top: 20px;
        text-align: right;
      }
      .edit-btn, .save-btn, .cancel-btn {
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .edit-btn {
        background: #e7f3ff;
        color: #0066cc;
      }
      .save-btn {
        background: #28a745;
        color: white;
        margin-right: 10px;
      }
      .cancel-btn {
        background: #dc3545;
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="nav-links">
      <a href="/">Add New Item</a>
      <a href="/search">Quick Search</a>
      <a href="/advanced-search">Advanced Search</a>
      <a href="/bulk-import">Bulk Import</a>
    </div>

    <h1>Search SOC Inventory</h1>

      <form class="search-form" id="searchForm">
        <input 
          type="search" 
          id="searchInput" 
          name="q" 
          placeholder="Search by label, type, brand, etc..."
          value="{{ request.args.get('q', '') }}"
        >
        <button type="submit">Search</button>
        {% if items %}
          <button type="button" onclick="downloadCSV()" class="download-btn">
            Download Results as CSV
          </button>
        {% endif %}
      </form>    <div id="results">
      {% if items %}
        <table>
          <thead>
            <tr>
              <th>Label</th>
              <th>Type</th>
              <th>Brand</th>
              <th>Model</th>
              <th>Serial No</th>
              <th>Location</th>
              <th>Status</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr data-id="{{ loop.index }}">
                <td>{{ item.label }}</td>
                <td>{{ item.type }}</td>
                <td>{{ item.brand }}</td>
                <td>{{ item.model_no }}</td>
                <td>{{ item.serial_no }}</td>
                <td>{{ item.location }}{% if item.location_2 %} / {{ item.location_2 }}{% endif %}</td>
                <td>{{ item.status }}</td>
                <td title="Created: {{ item.created_at }}">{{ item.updated_at }}</td>
                <td>
                  <button onclick="editItem({{ loop.index }})" class="edit-btn">Edit</button>
                </td>
              </tr>
              <tr id="edit-form-{{ loop.index }}" style="display: none;">
                <td colspan="8">
                  <form class="edit-form" onsubmit="updateItem(event, {{ loop.index }})">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Record Date</label>
                        <input type="date" name="record_date" value="{{ item.record_date }}">
                      </div>
                      <div class="form-group">
                        <label>Label</label>
                        <input type="text" name="label" value="{{ item.label }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Type</label>
                        <input type="text" name="type" value="{{ item.type }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Brand</label>
                        <input type="text" name="brand" value="{{ item.brand }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Model No</label>
                        <input type="text" name="model_no" value="{{ item.model_no }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Serial No</label>
                        <input type="text" name="serial_no" value="{{ item.serial_no }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="location" value="{{ item.location }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Location 2</label>
                        <input type="text" name="location_2" value="{{ item.location_2 }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Invoice No</label>
                        <input type="text" name="invoice_no" value="{{ item.invoice_no }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" name="purchase_date" value="{{ item.purchase_date }}">
                      </div>
                      <div class="form-group">
                        <label>Price</label>
                        <input type="number" name="price" value="{{ item.price }}" step="0.01">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Maintenance End Date</label>
                        <input type="date" name="maintenance_end_date" value="{{ item.maintenance_end_date }}">
                      </div>
                      <div class="form-group">
                        <label>Status</label>
                        <input type="text" name="status" value="{{ item.status }}" maxlength="50">
                      </div>
                    </div>
                    <div class="button-row">
                      <button type="submit" class="save-btn">Save Changes</button>
                      <button type="button" onclick="cancelEdit({{ loop.index }})" class="cancel-btn">Cancel</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% elif search_performed %}
        <div class="no-results">No items found matching your search.</div>
      {% endif %}
    </div>

    <script>
      // Function to download search results as CSV
      async function downloadCSV() {
        const searchQuery = document.getElementById('searchInput').value;
        try {
          const response = await fetch(`/api/items/export-csv?q=${encodeURIComponent(searchQuery)}`, {
            method: 'GET',
          });
          
          if (!response.ok) {
            throw new Error('Failed to download CSV');
          }

          // Get filename from Content-Disposition header or use default
          let filename = 'inventory-export.csv';
          const disposition = response.headers.get('Content-Disposition');
          if (disposition && disposition.indexOf('attachment') !== -1) {
            const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
            const matches = filenameRegex.exec(disposition);
            if (matches != null && matches[1]) {
              filename = matches[1].replace(/['"]/g, '');
            }
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.style.display = 'none';
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
        } catch (err) {
          alert('Error downloading CSV: ' + err.message);
        }
      }

      // Enable instant search as user types (with debouncing)
      const searchInput = document.getElementById('searchInput');
      const searchForm = document.getElementById('searchForm');
      let timeoutId;

      searchInput.addEventListener('input', (e) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
          searchForm.submit();
        }, 300); // Wait 300ms after user stops typing
      });

      // Edit functionality
      function editItem(id) {
        // Hide all other edit forms first
        document.querySelectorAll('.edit-form').forEach(form => {
          form.parentElement.parentElement.style.display = 'none';
        });
        // Show this edit form
        document.getElementById(`edit-form-${id}`).style.display = 'table-row';
      }

      function cancelEdit(id) {
        document.getElementById(`edit-form-${id}`).style.display = 'none';
      }

      async function updateItem(event, id) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        
        // Convert FormData to object with proper null handling
        const payload = {};
        for (let [key, value] of formData.entries()) {
          payload[key] = value.trim() || null;
        }

        try {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            // Refresh the page to show updated data
            window.location.reload();
          } else {
            const data = await res.json();
            alert(data.error || 'Failed to update item');
          }
        } catch (err) {
          alert('Network error: ' + err.message);
        }
      }

      // CSV Import functionality

    </script>
  </body>
</html>