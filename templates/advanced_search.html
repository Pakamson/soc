<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Advanced Search - SOC Inventory</title>
    <style>
      body { 
        font-family: Arial, sans-serif; 
        max-width: 1200px; 
        margin: 40px auto; 
        padding: 0 20px;
      }
      .nav-links {
        margin-bottom: 20px;
      }
      .nav-links a {
        margin-right: 15px;
        color: #0066cc;
        text-decoration: none;
      }
      .nav-links a:hover {
        text-decoration: underline;
      }
      .search-form {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
      }
      .form-row {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
      }
      .form-group {
        flex: 1;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        color: #495057;
      }
      .form-group input, .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
      }
      .actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
      }
      button {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .search-btn {
        background: #0066cc;
        color: white;
      }
      .clear-btn {
        background: #6c757d;
        color: white;
      }
      .download-btn {
        background: #28a745;
        color: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
      }
      th { 
        background: #f8f9fa;
        position: sticky;
        top: 0;
      }
      tr:hover { background: #f5f5f5; }
      .no-results {
        text-align: center;
        padding: 40px;
        color: #6c757d;
      }
      .date-range {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .date-range label {
        white-space: nowrap;
      }
      .price-range {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .price-range label {
        white-space: nowrap;
      }
    </style>
  </head>
  <body>
    <div class="nav-links">
      <a href="/dashboard">Dashboard</a>
      <a href="/add">Add New Item</a>
      <a href="/search">Quick Search</a>
      <a href="/advanced-search">Advanced Search</a>
      <a href="/bulk-import">Bulk Import</a>
    </div>

    <h1>Advanced Search</h1>

    <form class="search-form" id="advancedSearchForm" method="GET">
      <div class="form-row">
        <div class="form-group">
          <label>Record Date Range</label>
          <div class="date-range">
            <input type="date" name="record_date_start" value="{{ request.args.get('record_date_start', '') }}">
            <label>to</label>
            <input type="date" name="record_date_end" value="{{ request.args.get('record_date_end', '') }}">
          </div>
        </div>
        <div class="form-group">
          <label>Purchase Date Range</label>
          <div class="date-range">
            <input type="date" name="purchase_date_start" value="{{ request.args.get('purchase_date_start', '') }}">
            <label>to</label>
            <input type="date" name="purchase_date_end" value="{{ request.args.get('purchase_date_end', '') }}">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Maintenance End Date Range</label>
          <div class="date-range">
            <input type="date" name="maintenance_date_start" value="{{ request.args.get('maintenance_date_start', '') }}">
            <label>to</label>
            <input type="date" name="maintenance_date_end" value="{{ request.args.get('maintenance_date_end', '') }}">
          </div>
        </div>
        <div class="form-group">
          <label>Price Range</label>
          <div class="price-range">
            <input type="number" step="0.01" name="price_min" placeholder="Min" value="{{ request.args.get('price_min', '') }}">
            <label>to</label>
            <input type="number" step="0.01" name="price_max" placeholder="Max" value="{{ request.args.get('price_max', '') }}">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Label</label>
          <input type="text" name="label" value="{{ request.args.get('label', '') }}" placeholder="Search by label">
        </div>
        <div class="form-group">
          <label>Type</label>
          <input type="text" name="type" value="{{ request.args.get('type', '') }}" placeholder="Search by type">
        </div>
        <div class="form-group">
          <label>Brand</label>
          <input type="text" name="brand" value="{{ request.args.get('brand', '') }}" placeholder="Search by brand">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Vendor</label>
          <input type="text" name="vendor" value="{{ request.args.get('vendor', '') }}" placeholder="Search by vendor">
        </div>
        <div class="form-group">
          <label>Model No</label>
          <input type="text" name="model_no" value="{{ request.args.get('model_no', '') }}" placeholder="Search by model number">
        </div>
        <div class="form-group">
          <label>Serial No</label>
          <input type="text" name="serial_no" value="{{ request.args.get('serial_no', '') }}" placeholder="Search by serial number">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Invoice No</label>
          <input type="text" name="invoice_no" value="{{ request.args.get('invoice_no', '') }}" placeholder="Search by invoice number">
        </div>
        <div class="form-group">
          <label>Location 2</label>
          <input type="text" name="location_2" value="{{ request.args.get('location_2', '') }}" placeholder="Search by secondary location">
        </div>
        <div class="form-group">
          <label>Location 3</label>
          <input type="text" name="location_3" value="{{ request.args.get('location_3', '') }}" placeholder="Search by tertiary location">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Specification 1</label>
          <input type="text" name="specification1" value="{{ request.args.get('specification1', '') }}" placeholder="Search by specification 1">
        </div>
        <div class="form-group">
          <label>Specification 2</label>
          <input type="text" name="specification2" value="{{ request.args.get('specification2', '') }}" placeholder="Search by specification 2">
        </div>
        <div class="form-group">
          <label>Specification 3</label>
          <input type="text" name="specification3" value="{{ request.args.get('specification3', '') }}" placeholder="Search by specification 3">
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Project Code</label>
          <input type="text" name="project_code" value="{{ request.args.get('project_code', '') }}" placeholder="Search by project code">
        </div>
        <div class="form-group">
          <label>Department</label>
          <input type="text" name="department" value="{{ request.args.get('department', '') }}" placeholder="Search by department">
        </div>
        <div class="form-group">
          <label>Status</label>
          <input type="text" name="status" value="{{ request.args.get('status', '') }}" placeholder="Search by status">
        </div>
      </div>

      <div class="actions">
        <button type="submit" class="search-btn">Search</button>
        <button type="button" class="clear-btn" onclick="clearForm()">Clear All</button>
        {% if items %}
          <button type="button" class="download-btn" onclick="downloadResults()">Download Results</button>
        {% endif %}
      </div>
    </form>

    <div id="results">
      {% if items %}
        <table>
          <thead>
            <tr>
              <th>Label</th>
              <th>Type</th>
              <th>Brand</th>
              <th>Vendor</th>
              <th>Model</th>
              <th>Serial No</th>
              <th>Location</th>
              <th>Location 2</th>
              <th>Location 3</th>
              <th>Spec 1</th>
              <th>Spec 2</th>
              <th>Spec 3</th>
              <th>Status</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for item in items %}
              <tr data-id="{{ loop.index }}">
                <td>{{ item.label }}</td>
                <td>{{ item.type }}</td>
                <td>{{ item.brand }}</td>
                <td>{{ item.vendor }}</td>
                <td>{{ item.model_no }}</td>
                <td>{{ item.serial_no }}</td>
                <td>{{ item.location }}</td>
                <td>{{ item.location_2 }}</td>
                <td>{{ item.location_3 }}</td>
                <td>{{ item.specification1 }}</td>
                <td>{{ item.specification2 }}</td>
                <td>{{ item.specification3 }}</td>
                <td>{{ item.status }}</td>
                <td title="Created: {{ item.created_at }}">{{ item.updated_at }}</td>
                <td>
                  <button onclick="editItem({{ loop.index }})" class="edit-btn">Edit</button>
                </td>
              </tr>
              <tr id="edit-form-{{ loop.index }}" style="display: none;">
                <td colspan="15">
                  <form class="edit-form" onsubmit="updateItem(event, {{ loop.index }})">
                    <div class="form-row">
                      <div class="form-group">
                        <label>Record Date</label>
                        <input type="date" name="record_date" value="{{ item.record_date }}">
                      </div>
                      <div class="form-group">
                        <label>Label</label>
                        <input type="text" name="label" value="{{ item.label }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Type</label>
                        <input type="text" name="type" value="{{ item.type }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Brand</label>
                        <input type="text" name="brand" value="{{ item.brand }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Vendor</label>
                        <input type="text" name="vendor" value="{{ item.vendor }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Model No</label>
                        <input type="text" name="model_no" value="{{ item.model_no }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Serial No</label>
                        <input type="text" name="serial_no" value="{{ item.serial_no }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Location</label>
                        <input type="text" name="location" value="{{ item.location }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Location 2</label>
                        <input type="text" name="location_2" value="{{ item.location_2 }}" maxlength="100">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Invoice No</label>
                        <input type="text" name="invoice_no" value="{{ item.invoice_no }}" maxlength="100">
                      </div>
                      <div class="form-group">
                        <label>Purchase Date</label>
                        <input type="date" name="purchase_date" value="{{ item.purchase_date }}">
                      </div>
                      <div class="form-group">
                        <label>Price</label>
                        <input type="number" name="price" value="{{ item.price }}" step="0.01">
                      </div>
                    </div>
                    <div class="form-row">
                      <div class="form-group">
                        <label>Maintenance End Date</label>
                        <input type="date" name="maintenance_end_date" value="{{ item.maintenance_end_date }}">
                      </div>
                      <div class="form-group">
                        <label>Status</label>
                        <input type="text" name="status" value="{{ item.status }}" maxlength="50">
                      </div>
                    </div>
                    <div class="button-row">
                      <button type="submit" class="save-btn">Save Changes</button>
                      <button type="button" onclick="cancelEdit({{ loop.index }})" class="cancel-btn">Cancel</button>
                    </div>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% elif search_performed %}
        <div class="no-results">No items found matching your search criteria.</div>
      {% endif %}
    </div>

    <script>
      function clearForm() {
        document.getElementById('advancedSearchForm').reset();
        // Optionally submit the form after clearing to show all results
        // document.getElementById('advancedSearchForm').submit();
      }

      function downloadResults() {
        // Get current search parameters
        const params = new URLSearchParams(window.location.search);
        // Redirect to CSV export with same parameters
        window.location.href = `/api/items/export-csv?${params.toString()}`;
      }

      // Edit functionality (inline forms) - same as Quick Search
      function editItem(id) {
        // Hide all other edit forms first
        document.querySelectorAll('.edit-form').forEach(form => {
          form.parentElement.parentElement.style.display = 'none';
        });
        // Show this edit form
        document.getElementById(`edit-form-${id}`).style.display = 'table-row';
      }

      function cancelEdit(id) {
        document.getElementById(`edit-form-${id}`).style.display = 'none';
      }

      async function updateItem(event, id) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        // Convert FormData to object with proper null handling
        const payload = {};
        for (let [key, value] of formData.entries()) {
          payload[key] = value.trim() || null;
        }

        try {
          const res = await fetch(`/api/items/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (res.ok) {
            // Refresh the page to show updated data
            window.location.reload();
          } else {
            const data = await res.json();
            alert(data.error || 'Failed to update item');
          }
        } catch (err) {
          alert('Network error: ' + err.message);
        }
      }
    </script>
  </body>
</html>